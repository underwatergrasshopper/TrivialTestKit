name: Build and Test

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main" ]

env:
  SOLUTION_FILE_PATH: .

permissions:
  contents: read

jobs:
#  msvc:
#    strategy:
#      matrix:
#        os: [windows-2019, windows-2022]
#        platform: [x86, x64]
#        configuration: [Release, ReleaseWide]
#        include:
#          - os: windows-2019
#            toolset: v142
#          - os: windows-2022
#            toolset: v143
#          - platform: x86
#            pathprefix:
#          - platform: x64
#            pathprefix: x64/
#  
#    runs-on: ${{ matrix.os }}
#
#    steps:
#    - uses: actions/checkout@v3
#
#    - name: Add MSBuild to PATH
#      uses: microsoft/setup-msbuild@v1.0.2
#
#    - name: Build 
#      working-directory: ${{env.GITHUB_WORKSPACE}}
#      run: MSBuild /m /property:Configuration=${{ matrix.configuration }} /property:Platform=${{ matrix.platform }} /p:PlatformToolset=${{ matrix.toolset }}
#      
#    - name: Test
#      working-directory: ${{env.GITHUB_WORKSPACE}}
#      run: ./Build/${{ matrix.pathprefix }}${{ matrix.configuration }}/Test.exe
#      
  mingw_llvm:
    runs-on: windows-latest
    
    strategy:
      matrix:
        test_script: [TestMinGW_32.bat, TestMinGW_64.bat, TestMinGW_32_Wide.bat, TestMinGW_64_Wide.bat]
        include:
          - test_script: TestMinGW_32.bat
            mingw_folder: llvm-mingw-20220906-ucrt-i686
            build_path: Build/MinGW_LLVM/Release
          - test_script: TestMinGW_32_Wide.bat
            mingw_folder: llvm-mingw-20220906-ucrt-i686
            build_path: Build/MinGW_LLVM/ReleaseWide/
          - test_script: TestMinGW_64.bat
            mingw_folder: llvm-mingw-20220906-ucrt-x86_64
            build_path: Build/MinGW_LLVM/x64/Release/       
          - test_script: TestMinGW_64_Wide.bat
            mingw_folder: llvm-mingw-20220906-ucrt-x86_64
            build_path: Build/MinGW_LLVM/x64/ReleaseWide/ 
    steps:
      - name: Install Checkout
        uses: actions/checkout@v3
        
      - name: Install MSYS
        uses: msys2/setup-msys2@v2
      
      - name: Download MinGW
        shell: msys2 {0}
        run: wget https://github.com/mstorsjo/llvm-mingw/releases/download/20220906/${{ matrix.mingw_folder }}.zip -P C:/ 
          
      - name: Extract MinGW
        working-directory: C:\
        run: 7z x ${{ matrix.mingw_folder }}.zip
 
      - name: Build
        working-directory: ${{env.GITHUB_WORKSPACE}}
        run: ./${{ matrix.test_script }} build
        
      - name: Test
        working-directory: ${{env.GITHUB_WORKSPACE}}
        run: |
          cd Test
          Add-Content $env:GITHUB_PATH "C:\${{ matrix.mingw_folder }}\bin"
          ./${{ matrix.build_path }}Test.exe
          cd ..
      